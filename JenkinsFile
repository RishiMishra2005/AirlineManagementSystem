pipeline {
	agent {
		docker {
			image 'eclipse-temurin:21-jdk'
			args '-v $HOME/.m2:/root/.m2'
		}
	}
	
	environment {
		EC2_HOST = 'ec2-user@65.1.248.245'
		JAR_NAME = 'target/airline-0.0.1-SNAPSHOT.jar'
		REMOTE_PATH = '/home/ec2-user/app.jar'
	}
	
	stages {
		stage('Checkout Code') {
			steps {
				checkout scm
			}
		}
	
		stage('Build & Test') {
			steps {
				sh 'mvn clean package -DskipTests=false'
			}
		}
	
		stage('Copy JAR to EC2') {
			steps {
		  		withCredentials([file(credentialsId: 'ec2-key', variable: 'EC2_KEY')]) {
		    	sh '''
		      	chmod 400 ${EC2_KEY}
		        scp -o StrictHostKeyChecking=no -i ${EC2_KEY} ${JAR_NAME} ${EC2_HOST}:${REMOTE_PATH}
		      	'''
		    	}
		  	}
		}
	
		stage('Run JAR on EC2') {
			steps {
	  			withCredentials([file(credentialsId: 'ec2-key', variable: 'EC2_KEY')]) {
			    sh '''
		        ssh -o StrictHostKeyChecking=no -i ${EC2_KEY} ${EC2_HOST} << EOF
		          pkill -f 'java.*app.jar' || true
		          nohup java -jar ${REMOTE_PATH} > app.log 2>&1 &
		        EOF
		      	'''
		    	}
		  	}
		}
	
	}

	post {
		success {
			echo 'Deployment complete. App running on EC2.'
		}
		failure {
			echo 'Deployment failed.'
		}
	}
}